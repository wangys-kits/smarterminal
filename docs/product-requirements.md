# Smarterminal MVP PRD（Final）

> 说明：本项目为纯人工提词 + 纯 AI 编码产物。本 PRD 仅包含产品与实现要点，不含里程碑/管理性内容。

## 产品定位
- 面向开发者的跨平台“终端 + 文件管理”应用；本地与 SSH 场景一体化，高效稳健、易上手
- 内置自动更新；支持多窗口/多实例；中/英双语界面

## 范围与非目标
- 范围（MVP）：终端、SSH/SFTP、端口转发与 SSH Agent 转发、标签、多窗口、上下分栏、上传/下载、断点续传、会话持久化
- 非目标（MVP 不做）：插件系统、终端分屏（上下结构外）、协作/会话共享、S3/FTP、复杂权限审计、内置编辑器

## 平台与发布
- 平台：macOS（Intel/Apple Silicon）、Windows 10+/11（x64/ARM64）、Linux（x64 主流发行版）
- 自动更新：
  - Windows/macOS：electron-updater 差分更新，后台静默下载 + 用户确认安装
  - Linux：默认“检查更新并跳转下载页”；AppImage 可选启用自更新；DEB/RPM 无内置自动更新
  - 企业/离线：支持禁用自动更新与离线包
- 签名与校验：Windows 代码签名、macOS Notarization；安装包校验

## 架构选型
- Electron + TypeScript；主进程/渲染进程/预加载分层，IPC 白名单
- 终端：node-pty + xterm.js；优先启用 GPU 渲染，可开关
- SSH/SFTP：ssh2（端口转发/Agent 转发/跳板）、ssh2-sftp-client（并发/续传）
- 存储：
  - 配置与会话：JSON/SQLite（本地）
  - 凭据：Keychain（macOS）/Credential Manager（Windows）/libsecret 或同类（Linux）优先；失败回退为本地加密仓（需主密码）；用户可选“仅会话记忆”

## 界面布局
- 顶部：标签栏（多开/关闭/关闭右侧/关闭其他/全部关闭/重命名；不支持拖拽排序）
- 中部：上下两区，上：终端，下：文件区；中线可拖动；比例记忆（见“布局策略”）
- 文件区：路径栏 + 操作条 + 列表；可切换显示隐藏文件

## 终端能力
- Shell 选择：
  - Windows：PowerShell、WSL、cmd（优先 ConPTY）
  - macOS/Linux：zsh、bash、fish
  - 可设默认 Shell
- 基础：查找、复制粘贴、主题（亮/暗+若干配色）、字体/字号、滚动缓冲区大小
- 兼容性：TrueColor、emoji/中文、IME 输入；编码：UTF-8/系统本地编码切换（Windows 不强制 chcp，提供“更偏好 UTF-8”开关）
- SSH 增强：本地/远程/动态（SOCKS）端口转发；SSH Agent 转发（默认关闭）
- 重连：默认不自动重连；终端内显示“按回车重连至 <主机>”指引与错误原因

## SSH 与主机管理
- 连接项：主机、端口、用户、认证（密码/私钥/passphrase/Agent）、可选 ProxyJump/ProxyCommand
- 标签：默认名取 Host/Hostname/别名，支持重命名并保存
- KnownHosts：
  - 优先复用系统 ~/.ssh/known_hosts（含 hashed host）；应用内维护附加条目文件
  - 展示 SHA256 指纹；禁用 MD5；拒绝过时算法（如 DSS、rsa-sha1），建议 ed25519/rsa-sha2-256/512/ecdsa
  - 指纹不匹配视为高危，需显式确认且可记录“仅此次”或“信任并更新记录”
- 端口/Agent 转发：
  - 默认关闭；连接级开关；重连后按配置恢复
  - 端口占用冲突：自动向上递增端口（最多尝试 5 次）或提示选择；提供去重与状态可视化

## 文件管理与路径同步
- 路径同步：文件区跟随当前终端 CWD；可展示本地或远程路径
- 服务器与 CWD 识别：
  - 首选终端转义序列（OSC 7/OSC 133）+ Shell 集成脚本
  - 备选基于命令/提示解析（准确性较低，默认关闭）
  - 默认策略：检测到主机/路径变化时显示轻提示“切换到 <host>:<cwd>？”（确认后切换）；提供“始终自动切换/不再提示”开关（连接级/全局）
- 刷新：手动刷新（按钮/F5），不做自动轮询
- WSL：Windows 的 WSL 会话使用 \\wsl$ 映射访问；不可达或性能较差时提示并提供说明
- 列表列：名称、大小、类型、修改时间、权限简述（只读展示）；symlink 显示链接标识
- 右键：上传、下载、重命名、删除、新建文件/文件夹、复制路径
  - “在系统文件管理器打开”：仅对本地有效；远程替换为“复制远程路径”
  - symlink：默认操作链接本身，提供“跳转到目标”动作

## 上传/下载与断点续传
- 交互：拖拽到文件区上传；右键上传/下载；下载支持默认目录与目录选择器
- 范围：文件与文件夹；多选并发（默认 3，可设置；具备自适应并发模型）
- 断点续传：
  - 能力探测：连接建立后进行 SFTP 随机写/断点能力探测；不支持则降级为整文件重传
  - 冲突策略：覆盖/跳过/重命名（name (n).ext）；对非法字符/保留名/超长路径做规范化与截断（必要时使用 hash 尾缀）
- 校验：
  - 默认基于“大小 + mtime”快速校验
  - 可选 SHA-256 校验：本地计算 + 远端通过 sha256sum/shasum 调用；命令不存在或权限受限则回退为快速校验
- 进度：显示速率/进度/剩余时间；可暂停/继续/取消；失败指数退避重试（最多 3 次）
- 大目录性能：客户端排序/筛选，采用虚拟列表与分批合并；超过 10k 项提示“逐步加载/筛选以提升速度”

## 标签、会话与布局
- 会话保存：连接信息、工作目录、终端滚动历史上限、环境/Shell、标签自定义名
- 恢复：启动恢复标签结构但不连接；标签内提示“按回车重连”；失败保留可重试
- 多窗口：多窗口互不干扰；设置与资源全局共享
- 布局策略：
  - 分割比例：全局默认 + 每窗口记忆（优先使用该窗口最近一次设置）；跨屏幕尺寸变化时按比例适配

## 快捷键（MVP 固定）
- 标签：新建 Cmd/Ctrl+T，关闭 Cmd/Ctrl+W，切换 Ctrl+Tab / Shift+Ctrl+Tab，重命名 Cmd/Ctrl+R
- 焦点：终端/文件区切换 Alt+↑/Alt+↓（或 Esc 回终端）
- 文件：刷新 F5；上传 Cmd/Ctrl+U；下载 Cmd/Ctrl+D

## 设置项
- 终端：主题、字体/字号、滚动缓冲区、默认 Shell、编码、TrueColor 开关
- 连接：KnownHosts 策略、Agent 转发默认、KeepAlive 间隔（默认 20s，重试 3 次）、端口转发规则模板
- 传输：默认下载目录、每次询问开关、并发数（含自适应开关）、完成校验开关
- 布局：分割比例（全局默认 + 每窗口记忆）、显示隐藏文件
- 更新/隐私：自动更新开关（Linux 默认提示下载）、匿名崩溃/使用统计（默认关闭）、日志级别（Info/Debug）

## 安全与隐私
- 凭据：优先系统钥匙串；失败回退为本地加密仓（主密码）；或仅会话记忆；默认不允许明文
- 日志：不记录终端内容与命令；敏感信息脱敏；一键打包日志
- 操作确认：删除/覆盖二次确认，可记住选择（会话内）

## 性能目标与限制
- 列表：虚拟列表；单目录 ≤ 10k 项流畅；超出时懒加载/筛选建议
- 传输：默认并发 3 + 自适应；单文件流控；≥ 10GB 大文件稳定续传（若服务端不支持随机写则提示降级）
- 资源：空闲常驻内存 < 300MB；可关闭 GPU 加速
- 搜索：xterm 搜索默认限制在最近 N=20000 行（可调）以控性能

## 错误处理与空态
- 连接失败：终端与弹窗同步提示，提供“编辑连接”入口
- 权限/空间：SFTP 权限错误在任务条标注；下载前空间不足预警；中断可续传
- 路径不可达：文件区提示并提供回到家目录按钮；WSL 不可达给出说明
- 主机/CWD 识别失败：顶部轻提示“未能识别当前主机/路径”，提供手动切换入口

## 国际化（i18n）
- UI 文案全量词条；中/英即时切换
- 需重启：终端主题/字体等深层设置在语言切换时可能需重启（界面展示“重启后生效”标识）
- 术语表统一；日期/大小/时间本地化

## 关键依赖（实现参考）
- node-pty、xterm.js、ssh2/ssh2-sftp-client、electron-updater、keytar、zod/yup

## 验收标准（节选）
- 终端：Windows/macOS/Linux 下 PowerShell/WSL/cmd/zsh/fish 正常使用；IME/中文/TrueColor 正常；搜索在 2 万行内流畅
- SSH：密码/私钥/Agent 认证通过；KnownHosts 首次确认后不再重复；拒绝不安全算法
- 端口/Agent：本地/远程/动态转发可用；端口冲突自动重试 ≤5 次或提示处理；重连后规则自动恢复
- 文件：文件/文件夹上传下载；10GB 文件中断后续传成功；服务端不支持随机写时提示并降级
- 校验：默认大小+mtime；启用 SHA-256 时，远端缺少工具会回退并提示
- 路径：安装 Shell 集成后 CWD/主机同步稳定；识别到主机切换时默认弹轻提示，用户确认后切换
- 会话/布局：重启恢复标签不自连；按回车重连并回到保存工作目录；分割比例在多窗口按策略记忆
- WSL：WSL 不可达时提供提示且不崩溃；\\wsl$ 性能弱时仍可操作并给出建议

---

## 变更摘要（相较上一版）
- 主机/CWD 切换：从静默自动切换改为默认弹轻提示，提供“始终自动/不再提示”开关
- 断点续传：新增能力探测与不支持时的降级策略；校验默认大小+mtime，SHA-256 为可选并带回退
- 自动更新：Linux 改为“提示+下载页”，AppImage 可选自更新；支持企业关闭自动更新
- 凭据：引入主密码本地加密仓回退与“仅会话记忆”选项
- KnownHosts：复用系统 known_hosts 并附加应用存储；统一显示 SHA256 指纹；禁用不安全算法
- 端口转发：默认关闭，增加冲突自动重试与上限
- WSL/Windows：明确 ConPTY/UTF-8 策略与 \\wsl$ 降级提示
- 文件区：远程禁用“在系统文件管理器打开”，引入 symlink 语义；大目录分批合并/虚拟列表
- 搜索/日志：限制搜索行数；不记录终端内容
- 布局：改为“全局默认 + 每窗口记忆”

